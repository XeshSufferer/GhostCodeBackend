### Chat Service

## DTO

### CreateChatRequestDTO
```
{
  "aliceId": "string"
}
```

### SendMessageRequestDTO
```
{
  "chatId": "string",
  "replyTo": "string",
  "message": "string"
}
```

---

## SignalR Hub

### Подключение к Hub

**Endpoint**: `/chat`

**Требования**: 
- **Auth**: Требуется валидный JWT токен
- Подключение через SignalR WebSocket

**Пример подключения (JavaScript)**:
```javascript
const connection = new signalR.HubConnectionBuilder()
    .withUrl("/chat", {
        accessTokenFactory: () => jwtToken
    })
    .build();
```

---

## Методы Hub

### CreateChat

**Метод**: `CreateChat`

**Требования**: 
- **Auth**: Требуется валидный JWT токен
- Пользователь должен быть авторизован

**Параметры**: CreateChatRequestDTO
- `aliceId`: ID пользователя, с которым создается чат

**События ответа**:
- `ChatCreatedSuccessfully` - Чат успешно создан, возвращает объект Chat
- `ChatCreationFailed` - Ошибка создания чата, возвращает строку с описанием ошибки

**Пример объекта Chat в ответе**:
```
{
  "id": "string",
  "name": "string",
  "membersIds": ["string"],
  "createdAt": "2025-01-01T00:00:00Z",
  "messagesCount": 0,
  "messagesChunkCount": 0
}
```

**Примечания**:
- Если второй пользователь онлайн, он также получит событие `ChatCreatedSuccessfully`
- Чат создается между текущим пользователем (из JWT) и пользователем с `aliceId`

---

### SendMessage

**Метод**: `SendMessage`

**Требования**: 
- **Auth**: Требуется валидный JWT токен
- Пользователь должен быть участником чата

**Параметры**: SendMessageRequestDTO
- `chatId`: ID чата
- `replyTo`: ID сообщения, на которое отвечаем (может быть пустой строкой)
- `message`: Текст сообщения

**События ответа**:
- `MessageReceive` - Сообщение успешно отправлено и получено участниками чата, возвращает объект Message
- `SendMessageError` - Ошибка отправки сообщения, возвращает строку с описанием ошибки

**Пример объекта Message в ответе**:
```
{
  "id": "string",
  "senderId": "string",
  "chatId": "string",
  "text": "string",
  "replyToId": "string",
  "reactions": [],
  "pictureLinks": [],
  "createdAt": "2025-01-01T00:00:00Z"
}
```

**Примечания**:
- Сообщение автоматически отправляется всем участникам чата, которые находятся онлайн
- Если участник офлайн, сообщение сохраняется в базе данных и будет доступно при следующем подключении

---

## Автоматические события

### OnConnected

При подключении к Hub:
- Пользователь автоматически регистрируется в системе как онлайн
- Его connectionId сохраняется в кеше для отправки сообщений

### OnDisconnected

При отключении от Hub:
- Пользователь автоматически удаляется из списка онлайн пользователей
- Сообщения будут сохраняться в базе данных до следующего подключения

---

## Rate Limits ⚡

- **Глобальный лимит**: Не применяется (SignalR использует WebSocket соединение)
- **Примечание**: Rate limiting контролируется на уровне авторизации и подключения

### Важные замечания:
- Подключение к Hub требует валидный JWT токен
- При истечении токена соединение будет разорвано
- Рекомендуется реализовать переподключение на клиенте при потере соединения

